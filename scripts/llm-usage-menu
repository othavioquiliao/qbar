#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
export PATH="$HOME/.local/share/omarchy/bin:$PATH"
MENU_BIN="omarchy-launch-walker"

if ! command -v "$MENU_BIN" >/dev/null 2>&1; then
  echo "omarchy-launch-walker not found" >&2
  exit 1
fi

ensure_bun() {
  if command -v bun >/dev/null 2>&1; then
    return 0
  fi
  if command -v mise >/dev/null 2>&1; then
    if mise which bun >/dev/null 2>&1; then
      export PATH="$HOME/.local/share/mise/shims:$PATH"
      return 0
    fi
  fi
  if [ -x "$HOME/.local/share/mise/shims/bun" ]; then
    export PATH="$HOME/.local/share/mise/shims:$PATH"
    return 0
  fi
  echo "Bun not found. Installing via Omarchy..."
  omarchy-install-dev-env bun
}

ensure_pkg() {
  local bin="$1"
  local pkg="$2"
  if command -v "$bin" >/dev/null 2>&1; then
    return 0
  fi
  echo "Installing $pkg via yay..."
  yay -S --needed "$pkg"
}

login_antigravity() {
  ensure_pkg antigravity aur/antigravity
  ensure_bun
  export PATH="$HOME/.cache/.bun/bin:$PATH"
  if ! command -v antigravity-usage >/dev/null 2>&1; then
    echo "Installing antigravity-usage..."
    bun i -g antigravity-usage
  fi
  "$SCRIPT_DIR/antigravity-waybar-usage-login"
  pkill -USR2 waybar || true
}

login_claude() {
  ensure_pkg claude aur/claude-code
  echo -e "\n\e[1;32mClaude Login\e[0m"
  echo -e "\e[36mStep 1: Confirm the folder (trust prompt)\e[0m"
  echo -e "\e[36mStep 2: Type /login\e[0m"
  echo -e "\e[36mStep 3: Choose your login method (Subscription or API key)\e[0m"
  echo ""
  read -p "Press Enter to continue..." </dev/tty

  # watch for new credentials and refresh Waybar
  (while [ ! -f "$HOME/.claude/.credentials.json" ]; do sleep 1; done; pkill -USR2 waybar || true) &

  claude
}

login_codex() {
  ensure_bun
  export PATH="$HOME/.cache/.bun/bin:$PATH"
  if ! command -v codex >/dev/null 2>&1; then
    echo "Installing @openai/codex..."
    bun i -g @openai/codex
  fi
  codex
  pkill -USR2 waybar || true
}

OPTIONS=$(cat <<'EOF'
Show Details
Claude Login
Codex Login
Antigravity Login
Logout Provider
EOF
)

choice=$(echo "$OPTIONS" | $MENU_BIN --dmenu --width 280 --minheight 1 --maxheight 320 -p "LLM Usage" 2>/dev/null || true)

case "$choice" in
  "Show Details")
    "$SCRIPT_DIR/llm-usage-open-terminal" "$SCRIPT_DIR/llm-usage-details" ;;
  "Claude Login")
    omarchy-launch-floating-terminal-with-presentation "sh -lc 'SCRIPT_DIR=\"$SCRIPT_DIR\"; $(declare -f ensure_bun); $(declare -f ensure_pkg); $(declare -f login_claude); login_claude'" ;;
  "Codex Login")
    omarchy-launch-floating-terminal-with-presentation "bash -lc '$(declare -f ensure_pkg); $(declare -f login_codex); login_codex'" ;;
  "Antigravity Login")
    omarchy-launch-floating-terminal-with-presentation "sh -lc 'SCRIPT_DIR=\"$SCRIPT_DIR\"; $(declare -f ensure_bun); $(declare -f ensure_pkg); $(declare -f login_antigravity); login_antigravity'" ;;
  "Logout Provider")
    "$SCRIPT_DIR/llm-usage-logout" ;;
  *)
    exit 0 ;;
esac
