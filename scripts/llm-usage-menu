#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
export PATH="$HOME/.local/share/omarchy/bin:$PATH"
MENU_BIN="omarchy-launch-walker"

if ! command -v "$MENU_BIN" >/dev/null 2>&1; then
  echo "omarchy-launch-walker not found" >&2
  exit 1
fi

ensure_bun() {
  if command -v bun >/dev/null 2>&1; then
    return 0
  fi
  echo "Bun not found. Installing via Omarchy..."
  omarchy-install-dev-env bun
}

ensure_pkg() {
  local bin="$1"
  local pkg="$2"
  if command -v "$bin" >/dev/null 2>&1; then
    return 0
  fi
  echo "Installing $pkg via yay..."
  yay -S --needed "$pkg"
}

login_antigravity() {
  ensure_pkg antigravity antigravity
  ensure_bun
  if ! command -v antigravity-usage >/dev/null 2>&1; then
    echo "Installing antigravity-usage..."
    bun i -g antigravity-usage
  fi
  "$SCRIPT_DIR/antigravity-waybar-usage-login"
}

login_claude() {
  ensure_pkg claude claude-code
  claude
}

login_codex() {
  ensure_pkg codex codex
  codex
}

OPTIONS=$(cat <<'EOF'
Show Details
Claude Login
Codex Login
Antigravity Login
EOF
)

choice=$(echo "$OPTIONS" | $MENU_BIN --dmenu --width 280 --minheight 1 --maxheight 320 -p "LLM Usage" 2>/dev/null || true)

case "$choice" in
  "Show Details")
    omarchy-launch-floating-terminal-with-presentation "bash -lc '$SCRIPT_DIR/waybar-llm-usage.sh; echo; read -p \"Press Enter...\"'" ;;
  "Claude Login")
    omarchy-launch-floating-terminal-with-presentation "bash -lc '$(declare -f ensure_bun); $(declare -f ensure_pkg); $(declare -f login_claude); login_claude'" ;;
  "Codex Login")
    omarchy-launch-floating-terminal-with-presentation "bash -lc '$(declare -f ensure_pkg); $(declare -f login_codex); login_codex'" ;;
  "Antigravity Login")
    omarchy-launch-floating-terminal-with-presentation "bash -lc '$(declare -f ensure_bun); $(declare -f ensure_pkg); $(declare -f login_antigravity); login_antigravity'" ;;
  *)
    exit 0 ;;
esac
