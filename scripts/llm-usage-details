#!/usr/bin/env bash
set -u

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

OUT=$($SCRIPT_DIR/waybar-llm-usage.sh)
export OUT
python3 - <<'PY'
import json,os,re
raw=os.environ.get("OUT", "")
try:
    data=json.loads(raw)
    tip=data.get("tooltip", "")
    tip=tip.replace("\\n", "\n").replace("\\r", "")
    def span_to_ansi(m):
        color=m.group(1).lower()
        return {
            "a6e3a1": "\x1b[32m",
            "f9e2af": "\x1b[33m",
            "fab387": "\x1b[33m",
            "f38ba8": "\x1b[31m",
            "cdd6f4": "\x1b[37m",
            "6c7086": "\x1b[90m",
        }.get(color, "")
    tip=re.sub(r"<span[^>]*foreground=['\"]#([0-9a-fA-F]{6})['\"][^>]*>", span_to_ansi, tip)
    tip=tip.replace("</span>", "\x1b[0m")
    tip=re.sub(r"<[^>]+>", "", tip)
    print(tip+"\x1b[0m")
except Exception:
    print("(failed to parse tooltip)")
    print(raw)
PY
